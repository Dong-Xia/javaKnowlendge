# 基于独立消息服务的可靠消息最终一致性方案
## 介绍
基于本地消息服务实现的局限性，针对不足提出了基于独立消息服务的可靠消息最终一致性方案，该方案主要将本地消息服务和
消息恢复系统提取出来单独部署，以便其它服务共用。改进后的设计图如图1：
![独立消息服务设计](/src/main/images/独立消息服务设计.jpg)
　　　　　　　　　　　　　　　　　　　　　　图1　独立消息服务处理流程
## 独立消息服务实现的思想
### 根据描述中4个步骤分析本地消息服务的可行性
1. 消息发送一致性的正向流程（可靠消息的前提保障）-- 实现思路

    按照图1中，消息发送一致性分为预发送和确认两次处理流程：主动方应用系统生产消息到消息服务系统，消息服务系统存储预发送的消息后，
    经过消息状态确认子系统进行确认后，记录在消息表中，表设计如表1；消息系统再发送至MQ进行后续处理。
 ![本地消息业务表](/src/main/images/本地消息业务表.jpg)
    　　　　　　　　　　　　　　　　　　　     表１ 本地消息表

2. 消息发送一致性的异常处理流程 -- 如何解决

   图1中，主动方应用系统发送信息到消息服务系统出现问题，消息状态确认子系统保证出现问题后的消息重发；
   
   消息管理子系统作用：在经过几次消息重发超过设置的重发次数上限后，消息状态设置为死亡后，为了可以人工介入处理这些死亡消息而设计。
   
3. 消息投递（消费）的正向流程 -- 实现思路

　　这个步骤实现相对简单，和队列消费思想一致，只需正确实现消息的消费过程即可。

4. 消息投递（消费）的异常处理流程 -- 如何解决
   和本地消息服务实现处理异常一样，具体查看本地消息服务处理异常的办法。

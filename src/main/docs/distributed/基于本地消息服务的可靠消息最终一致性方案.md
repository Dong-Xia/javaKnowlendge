# 基于本地消息服务的可靠消息最终一致性方案
## 描述
　　如图所示为可靠消息服务最终一致性的完整处理流程，图中7个流程都可能发生异常，保证所有流程的可行性则能分布式事务的目标，
总结图中的流程为四种实现步骤：
![可靠消息流程](/src/main/images/可靠消息流程.jpg)
　　　　　　　　图1

    (1). 消息发送一致性的正向流程（可靠消息的前提保障）：生产者发送消息到消息队列的过程
    (2). 消息发送一致性的异常处理流程：生产者发送消息到消息队列的过程中出现的异常，如网络问题导致发送失败
    (3). 消息投递（消费）的正向流程：消息队列向消费者发送信息的消费过程
    (4). 消息投递（消费）的异常处理流程，需实现幂等：消息队列向消费者发送信息的消费过程出现的异常，如网络问题、消费过程处理异常等 
### 存在的问题
　　由于目前现成的消息中间件产品不支持图1消息发送一致的流程，具体为消息发送一致的流程实现是需先待提交后，等待确认成功2个步骤
后消息队列才会通知消费者进行消费；不可能去改造现有的消息中间件，这样成本太高，所以最佳解决方法为本地消息服务和独立消息服务的变通办法。
## 本地消息服务实现的思想
　　基于消息队列不能满足2步式流程的局限性，将信息待提交和确认步骤作为一个服务放置在本地，
并结合生产者生产信息服务一起，使用**本地事务实现数据一致性**。如图2所示。
![本地消息服务](/src/main/images/本地消息服务.jpg)
    　　　　　图２ 可靠消息最终一致性方案--本地消息服务
    
　　    
　　